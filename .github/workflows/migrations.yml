name: Supabase Migration Pipeline

on:
  push:
    branches:
      - staging
      - main

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment based on branch
        id: env
        run: |
          if [ "${{ github.ref_name }}" = "staging" ]; then
            echo "DB_URL=${{ secrets.SUPABASE_STAGING_DB_URL }}" >> $GITHUB_ENV
          else
            echo "DB_URL=${{ secrets.SUPABASE_PROD_DB_URL }}" >> $GITHUB_ENV
          fi

      - name: Connection Audit
        run: |
          if [ -z "$DB_URL" ]; then
            echo "::error::DB_URL secret is empty or not set. Migration cannot proceed."
            exit 1
          fi

      - name: Run Migrations (Robust Fallback)
        run: |
          echo "Starting robust psql-based migration runner..."

          # Create migration tracking table if it doesn't exist (Supabase standard)
          psql "$DB_URL" -c "CREATE SCHEMA IF NOT EXISTS supabase_migrations;"
          psql "$DB_URL" -c "CREATE TABLE IF NOT EXISTS supabase_migrations.schema_migrations (version text PRIMARY KEY, name text, statements text[], created_by text);"

          # Iterate through migrations in order
          for f in $(ls supabase/migrations/*.sql | sort); do
            VERSION=$(basename "$f" | cut -d'_' -f1)
            NAME=$(basename "$f" | cut -d'_' -f2- | sed 's/\.sql//')
            
            # Check if already applied
            APPLIED=$(psql "$DB_URL" -tAc "SELECT count(*) FROM supabase_migrations.schema_migrations WHERE version = '$VERSION';")
            
            if [ "$APPLIED" = "0" ]; then
              echo "Applying migration: $VERSION ($NAME)..."
              # Apply SQL and record success
              psql "$DB_URL" -f "$f" && \
              psql "$DB_URL" -c "INSERT INTO supabase_migrations.schema_migrations (version, name, created_by) VALUES ('$VERSION', '$NAME', 'ci-automation');"
            else
              echo "Migration $VERSION already applied. Skipping."
            fi
          done

      - name: Final Verification
        run: |
          echo "Verifying migration application..."
          psql "$DB_URL" -tAc "SELECT count(*) FROM pg_tables WHERE schemaname = 'public' AND tablename = 'pipeline_automation_proof';" | grep -q '1' || (echo "::error::Table 'pipeline_automation_proof' not found! Migration failed." && exit 1)
          echo "Migration verified successfully!"
